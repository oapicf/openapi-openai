#
# OpenAI API
# 
# The OpenAI REST API. Please see https://platform.openai.com/docs/api-reference for more details.
# The version of the OpenAPI document: 2.3.0
# Contact: blah+oapicf@cliffano.com
# Generated by: https://openapi-generator.tech
#

import httpclient
import json
import logging
import marshal
import options
import strformat
import strutils
import tables
import typetraits
import uri

import ../models/model_error_response
import ../models/model_project
import ../models/model_project_api_key
import ../models/model_project_api_key_delete_response
import ../models/model_project_api_key_list_response
import ../models/model_project_create_request
import ../models/model_project_list_response
import ../models/model_project_rate_limit
import ../models/model_project_rate_limit_list_response
import ../models/model_project_rate_limit_update_request
import ../models/model_project_service_account
import ../models/model_project_service_account_create_request
import ../models/model_project_service_account_create_response
import ../models/model_project_service_account_delete_response
import ../models/model_project_service_account_list_response
import ../models/model_project_update_request
import ../models/model_project_user
import ../models/model_project_user_create_request
import ../models/model_project_user_delete_response
import ../models/model_project_user_list_response
import ../models/model_project_user_update_request

const basepath = "https://api.openai.com/v1"

template constructResult[T](response: Response): untyped =
  if response.code in {Http200, Http201, Http202, Http204, Http206}:
    try:
      (some(to(parseJson(response.body), T)), response)
    except JsonParsingError:
      # The server returned a malformed response though the response code is 2XX
      # TODO: need better error handling
      error("JsonParsingError")
      (none(T.typedesc), response)
  else:
    (none(T.typedesc), response)


proc archiveProject*(httpClient: HttpClient, projectId: string): (Option[Project], Response) =
  ## Archives a project in the organization. Archived projects cannot be used or updated.

  let response = httpClient.post(basepath & fmt"/organization/projects/{project_id}/archive")
  constructResult[Project](response)


proc createProject*(httpClient: HttpClient, projectCreateRequest: ProjectCreateRequest): (Option[Project], Response) =
  ## Create a new project in the organization. Projects can be created and archived, but cannot be deleted.
  httpClient.headers["Content-Type"] = "application/json"

  let response = httpClient.post(basepath & "/organization/projects", $(%projectCreateRequest))
  constructResult[Project](response)


proc createProjectServiceAccount*(httpClient: HttpClient, projectId: string, projectServiceAccountCreateRequest: ProjectServiceAccountCreateRequest): (Option[ProjectServiceAccountCreateResponse], Response) =
  ## Creates a new service account in the project. This also returns an unredacted API key for the service account.
  httpClient.headers["Content-Type"] = "application/json"

  let response = httpClient.post(basepath & fmt"/organization/projects/{project_id}/service_accounts", $(%projectServiceAccountCreateRequest))
  constructResult[ProjectServiceAccountCreateResponse](response)


proc createProjectUser*(httpClient: HttpClient, projectId: string, projectUserCreateRequest: ProjectUserCreateRequest): (Option[ProjectUser], Response) =
  ## Adds a user to the project. Users must already be members of the organization to be added to a project.
  httpClient.headers["Content-Type"] = "application/json"

  let response = httpClient.post(basepath & fmt"/organization/projects/{project_id}/users", $(%projectUserCreateRequest))
  constructResult[ProjectUser](response)


proc deleteProjectApiKey*(httpClient: HttpClient, projectId: string, keyId: string): (Option[ProjectApiKeyDeleteResponse], Response) =
  ## Deletes an API key from the project.

  let response = httpClient.delete(basepath & fmt"/organization/projects/{project_id}/api_keys/{key_id}")
  constructResult[ProjectApiKeyDeleteResponse](response)


proc deleteProjectServiceAccount*(httpClient: HttpClient, projectId: string, serviceAccountId: string): (Option[ProjectServiceAccountDeleteResponse], Response) =
  ## Deletes a service account from the project.

  let response = httpClient.delete(basepath & fmt"/organization/projects/{project_id}/service_accounts/{service_account_id}")
  constructResult[ProjectServiceAccountDeleteResponse](response)


proc deleteProjectUser*(httpClient: HttpClient, projectId: string, userId: string): (Option[ProjectUserDeleteResponse], Response) =
  ## Deletes a user from the project.

  let response = httpClient.delete(basepath & fmt"/organization/projects/{project_id}/users/{user_id}")
  constructResult[ProjectUserDeleteResponse](response)


proc listProjectApiKeys*(httpClient: HttpClient, projectId: string, limit: int, after: string): (Option[ProjectApiKeyListResponse], Response) =
  ## Returns a list of API keys in the project.
  var query_params_list: seq[(string, string)] = @[]
  if $limit != "":
    query_params_list.add(("limit", $limit))
  if $after != "":
    query_params_list.add(("after", $after))
  let url_encoded_query_params = encodeQuery(query_params_list)

  let response = httpClient.get(basepath & fmt"/organization/projects/{project_id}/api_keys" & "?" & url_encoded_query_params)
  constructResult[ProjectApiKeyListResponse](response)


proc listProjectRateLimits*(httpClient: HttpClient, projectId: string, limit: int, after: string, before: string): (Option[ProjectRateLimitListResponse], Response) =
  ## Returns the rate limits per model for a project.
  var query_params_list: seq[(string, string)] = @[]
  if $limit != "":
    query_params_list.add(("limit", $limit))
  if $after != "":
    query_params_list.add(("after", $after))
  if $before != "":
    query_params_list.add(("before", $before))
  let url_encoded_query_params = encodeQuery(query_params_list)

  let response = httpClient.get(basepath & fmt"/organization/projects/{project_id}/rate_limits" & "?" & url_encoded_query_params)
  constructResult[ProjectRateLimitListResponse](response)


proc listProjectServiceAccounts*(httpClient: HttpClient, projectId: string, limit: int, after: string): (Option[ProjectServiceAccountListResponse], Response) =
  ## Returns a list of service accounts in the project.
  var query_params_list: seq[(string, string)] = @[]
  if $limit != "":
    query_params_list.add(("limit", $limit))
  if $after != "":
    query_params_list.add(("after", $after))
  let url_encoded_query_params = encodeQuery(query_params_list)

  let response = httpClient.get(basepath & fmt"/organization/projects/{project_id}/service_accounts" & "?" & url_encoded_query_params)
  constructResult[ProjectServiceAccountListResponse](response)


proc listProjectUsers*(httpClient: HttpClient, projectId: string, limit: int, after: string): (Option[ProjectUserListResponse], Response) =
  ## Returns a list of users in the project.
  var query_params_list: seq[(string, string)] = @[]
  if $limit != "":
    query_params_list.add(("limit", $limit))
  if $after != "":
    query_params_list.add(("after", $after))
  let url_encoded_query_params = encodeQuery(query_params_list)

  let response = httpClient.get(basepath & fmt"/organization/projects/{project_id}/users" & "?" & url_encoded_query_params)
  constructResult[ProjectUserListResponse](response)


proc listProjects*(httpClient: HttpClient, limit: int, after: string, includeArchived: bool): (Option[ProjectListResponse], Response) =
  ## Returns a list of projects.
  var query_params_list: seq[(string, string)] = @[]
  if $limit != "":
    query_params_list.add(("limit", $limit))
  if $after != "":
    query_params_list.add(("after", $after))
  if $includeArchived != "":
    query_params_list.add(("include_archived", $includeArchived))
  let url_encoded_query_params = encodeQuery(query_params_list)

  let response = httpClient.get(basepath & "/organization/projects" & "?" & url_encoded_query_params)
  constructResult[ProjectListResponse](response)


proc modifyProject*(httpClient: HttpClient, projectId: string, projectUpdateRequest: ProjectUpdateRequest): (Option[Project], Response) =
  ## Modifies a project in the organization.
  httpClient.headers["Content-Type"] = "application/json"

  let response = httpClient.post(basepath & fmt"/organization/projects/{project_id}", $(%projectUpdateRequest))
  constructResult[Project](response)


proc modifyProjectUser*(httpClient: HttpClient, projectId: string, userId: string, projectUserUpdateRequest: ProjectUserUpdateRequest): (Option[ProjectUser], Response) =
  ## Modifies a user's role in the project.
  httpClient.headers["Content-Type"] = "application/json"

  let response = httpClient.post(basepath & fmt"/organization/projects/{project_id}/users/{user_id}", $(%projectUserUpdateRequest))
  constructResult[ProjectUser](response)


proc retrieveProject*(httpClient: HttpClient, projectId: string): (Option[Project], Response) =
  ## Retrieves a project.

  let response = httpClient.get(basepath & fmt"/organization/projects/{project_id}")
  constructResult[Project](response)


proc retrieveProjectApiKey*(httpClient: HttpClient, projectId: string, keyId: string): (Option[ProjectApiKey], Response) =
  ## Retrieves an API key in the project.

  let response = httpClient.get(basepath & fmt"/organization/projects/{project_id}/api_keys/{key_id}")
  constructResult[ProjectApiKey](response)


proc retrieveProjectServiceAccount*(httpClient: HttpClient, projectId: string, serviceAccountId: string): (Option[ProjectServiceAccount], Response) =
  ## Retrieves a service account in the project.

  let response = httpClient.get(basepath & fmt"/organization/projects/{project_id}/service_accounts/{service_account_id}")
  constructResult[ProjectServiceAccount](response)


proc retrieveProjectUser*(httpClient: HttpClient, projectId: string, userId: string): (Option[ProjectUser], Response) =
  ## Retrieves a user in the project.

  let response = httpClient.get(basepath & fmt"/organization/projects/{project_id}/users/{user_id}")
  constructResult[ProjectUser](response)


proc updateProjectRateLimits*(httpClient: HttpClient, projectId: string, rateLimitId: string, projectRateLimitUpdateRequest: ProjectRateLimitUpdateRequest): (Option[ProjectRateLimit], Response) =
  ## Updates a project rate limit.
  httpClient.headers["Content-Type"] = "application/json"

  let response = httpClient.post(basepath & fmt"/organization/projects/{project_id}/rate_limits/{rate_limit_id}", $(%projectRateLimitUpdateRequest))
  constructResult[ProjectRateLimit](response)

